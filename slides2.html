<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>慈濟慈善事業基金會 志業分享</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=Noto+Serif+TC:wght@400;500;600;700&family=LXGW+WenKai+TC&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      color: white;
      background: #1a1a2e;
    }

    /* ===========================
       主容器
       =========================== */
    .app {
      width: 100vw;
      height: 100vh;
      display: flex;
      background-image: url('theme/default/background.jpg');
      background-size: cover;
      background-position: center;
    }

    /* ===========================
       左側面板
       =========================== */
    .left-panel {
      width: 100px;
      flex-shrink: 0;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .page-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #FFD700;
      font-weight: bold;
    }

    .page-indicator .current {
      font-size: 48px;
    }

    .page-indicator .separator {
      font-size: 24px;
      opacity: 0.6;
    }

    .page-indicator .total {
      font-size: 28px;
      opacity: 0.8;
    }

    /* ===========================
       內容區 - Container Query
       =========================== */
    .content-area {
      flex: 1;
      padding: 40px 60px;
      container-type: size;
      container-name: content;
      overflow: hidden;
    }

    /* ===========================
       稿紙 - 直書模式
       =========================== */
    .manuscript {
      width: 100cqw;
      height: 100cqh;
      overflow: hidden;

      writing-mode: vertical-rl;
      text-orientation: mixed;
    }

    /* ===========================
       文字樣式
       =========================== */
    h1, h2, h3 {
      font-family: "Noto Serif TC", serif;
      color: #5FCFC3;
      letter-spacing: 0.1em;
      line-height: 1.6;
    }

    h1 { font-size: calc(48px + 2cqi); margin-right: 1rem; }
    h2 { font-size: calc(36px + 1.5cqi); }
    h3 { font-size: calc(28px + 1cqi); color: #FFD700; }

    p {
      font-size: calc(24px + 1cqi);
      line-height: 1.8;
      letter-spacing: 0.08em;
      margin: 0 0.8rem;
    }

    ul, ol {
      list-style-position: inside;
      margin: 0 20px;
    }

    li {
      font-size: calc(24px + 1cqi);
      line-height: 1.8;
      margin-bottom: 0.5rem;
    }

    li::marker {
      color: #5FCFC3;
    }

    hr {
      display: none;
    }

    img {
      max-height: 70cqh;
      max-width: 80%;
      object-fit: contain;
      border-radius: 8px;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="left-panel">
      <div class="page-indicator">
        <span class="current" id="currentPage">1</span>
        <span class="separator">/</span>
        <span class="total" id="totalPages">?</span>
      </div>
    </aside>

    <main class="content-area">
      <div class="manuscript" id="manuscript">
        <!-- 內容載入這裡 -->
      </div>
    </main>
  </div>

  <script>
    const manuscript = document.getElementById('manuscript');
    const currentPageEl = document.getElementById('currentPage');
    const totalPagesEl = document.getElementById('totalPages');

    let currentPage = 0;
    let totalPages = 1;

    // 初始化
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const src = params.get('src');

      if (src) {
        await loadContent(src);
      } else {
        manuscript.innerHTML = '<p>請提供 src 參數</p>';
      }

      initNavigation();
    }

    // 載入內容
    async function loadContent(url) {
      try {
        const res = await fetch(url);
        let html = await res.text();

        // 修正圖片路徑
        const basePath = url.substring(0, url.lastIndexOf('/') + 1);
        html = html.replace(/src="(?!http|\/)(images\/[^"]+)"/g, `src="${basePath}$1"`);

        manuscript.innerHTML = html;

        // 等待渲染
        await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

        calculatePages();
      } catch (e) {
        manuscript.innerHTML = `<p>載入失敗: ${e.message}</p>`;
      }
    }

    // 計算頁數
    function calculatePages() {
      // vertical-rl: 內容向左溢出，用 scrollWidth
      const scrollW = manuscript.scrollWidth;
      const clientW = manuscript.clientWidth;

      totalPages = Math.max(1, Math.ceil(scrollW / clientW));
      console.log(`scrollWidth=${scrollW}, clientWidth=${clientW}, pages=${totalPages}`);

      updateDisplay();
    }

    // 更新顯示
    function updateDisplay() {
      currentPageEl.textContent = currentPage + 1;
      totalPagesEl.textContent = totalPages;
    }

    // 翻頁
    function goToPage(n) {
      if (n < 0) n = 0;
      if (n >= totalPages) n = totalPages - 1;

      currentPage = n;

      // vertical-rl: scrollLeft 負值向左滾動
      const pageWidth = manuscript.clientWidth;
      manuscript.scrollLeft = -currentPage * pageWidth;

      updateDisplay();
    }

    function nextPage() { goToPage(currentPage + 1); }
    function prevPage() { goToPage(currentPage - 1); }

    // 導航事件
    function initNavigation() {
      // 鍵盤
      document.addEventListener('keydown', e => {
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ') {
          e.preventDefault();
          nextPage();
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          e.preventDefault();
          prevPage();
        }
      });

      // 點擊
      document.querySelector('.content-area').addEventListener('click', e => {
        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        if (x < rect.width / 2) prevPage();
        else nextPage();
      });

      // 視窗大小改變
      window.addEventListener('resize', () => {
        setTimeout(calculatePages, 100);
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
